<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Copy Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- JSZip for creating zip files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Custom styles to match the React look */
        body { font-family: system-ui, -apple-system, sans-serif; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col text-slate-800">

    <!-- App Container -->
    <div id="app" class="flex flex-col min-h-screen"></div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium hidden flex items-center gap-2 transform transition-all duration-300 translate-y-10 opacity-0">
        <div class="w-2 h-2 rounded-full bg-green-400"></div>
        <span id="toast-message"></span>
    </div>

    <script>
        // --- Constants ---
        const ACCOUNTS = {
            NimiTV: {
                label: 'NimiTV',
                color: 'bg-blue-600',
                themeText: 'text-blue-600',
                themeBorder: 'border-blue-200',
                themeRing: 'ring-blue-500',
                campaigns: ['EU+EEA', 'UK', 'DE']
            },
            TVALB: {
                label: 'TVALB',
                color: 'bg-red-600',
                themeText: 'text-red-600',
                themeBorder: 'border-red-200',
                themeRing: 'ring-red-500',
                campaigns: ['US', 'Canada']
            }
        };

        // --- State Management ---
        const state = {
            account: 'NimiTV',
            campaign: 'EU+EEA',
            data: {}
        };

        // Initialize State
        function initData() {
            Object.keys(ACCOUNTS).forEach(acc => {
                state.data[acc] = {};
                ACCOUNTS[acc].campaigns.forEach(camp => {
                    state.data[acc][camp] = {
                        primaryTexts: Array(5).fill().map(() => ({ text: '', status: 'pending' })),
                        headlines: Array(5).fill().map(() => ({ text: '', status: 'pending' })),
                        selectedImage: null
                    };
                });
            });
        }
        initData();

        // --- DOM Elements ---
        const app = document.getElementById('app');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toast-message');

        // --- Helper Functions ---
        function showNotification(msg) {
            toastMsg.textContent = msg;
            toast.classList.remove('hidden');
            // Trigger reflow
            void toast.offsetWidth; 
            toast.classList.remove('translate-y-10', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function copyToClipboard(text) {
            if (!text) return;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('Copied to clipboard!');
            } catch (err) {
                showNotification('Failed to copy');
            }
            document.body.removeChild(textArea);
        }

        function getStatusClasses(status) {
            switch(status) {
                case 'approved': return 'ring-2 ring-green-500 bg-green-50/30';
                case 'rejected': return 'ring-2 ring-red-200 bg-red-50/30 opacity-70 grayscale';
                default: return 'bg-gray-50 focus:bg-white';
            }
        }

        function getCurrentData() {
            return state.data[state.account][state.campaign];
        }

        // --- Actions ---
        window.setAccount = (acc) => {
            state.account = acc;
            // Reset campaign if not valid for new account
            if (!ACCOUNTS[acc].campaigns.includes(state.campaign)) {
                state.campaign = ACCOUNTS[acc].campaigns[0];
            }
            render();
        };

        window.setCampaign = (camp) => {
            state.campaign = camp;
            render();
        };

        window.updateText = (type, index, value) => {
            const data = getCurrentData();
            data[type][index].text = value;
            render();
            // Maintain focus
            setTimeout(() => {
                const el = document.getElementById(`${type}-${index}`);
                if(el) {
                    el.focus();
                    el.setSelectionRange(el.value.length, el.value.length);
                }
            }, 0);
        };

        window.updateStatus = (type, index, status) => {
            const data = getCurrentData();
            data[type][index].status = status;
            render();
        };

        window.clearCampaign = () => {
            if (confirm('Are you sure you want to clear all text and media for this campaign?')) {
                const campData = getCurrentData();
                campData.primaryTexts = Array(5).fill().map(() => ({ text: '', status: 'pending' }));
                campData.headlines = Array(5).fill().map(() => ({ text: '', status: 'pending' }));
                campData.selectedImage = null;
                render();
                showNotification('Campaign data cleared');
            }
        };

        window.handleImageUpload = (input) => {
            const file = input.files[0];
            if (file) {
                if (!file.type.match('image.*')) {
                    showNotification('Please upload an image file (PNG/JPEG)');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = getCurrentData();
                    data.selectedImage = {
                        name: file.name,
                        data: event.target.result
                    };
                    render();
                    showNotification('Image uploaded successfully');
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeImage = () => {
            const data = getCurrentData();
            data.selectedImage = null;
            render();
        };

        window.exportPackage = () => {
            showNotification('Generating package...');
            const zip = new JSZip();
            const imgFolder = zip.folder("images");
            
            // Build CSV Header
            let csvContent = "Account,Campaign,Type,Index,Content,Status,Length,Related Image File\n";
            
            Object.keys(state.data).forEach(acc => {
                Object.keys(state.data[acc]).forEach(camp => {
                    const d = state.data[acc][camp];
                    let imageFileName = "None";

                    // Handle Image
                    if (d.selectedImage) {
                        // Create a unique filename for the image in the zip
                        const ext = d.selectedImage.name.split('.').pop() || 'png';
                        const safeName = `${acc}_${camp}_Image.${ext}`.replace(/[\/\\]/g, '_');
                        
                        // Strip base64 prefix to get raw data
                        const base64Data = d.selectedImage.data.replace(/^data:image\/(png|jpg|jpeg);base64,/, "");
                        
                        // Add to zip folder
                        imgFolder.file(safeName, base64Data, {base64: true});
                        imageFileName = `images/${safeName}`;
                    }

                    // Add Text Data to CSV
                    d.primaryTexts.forEach((item, idx) => {
                        if (item.text) {
                            csvContent += `${acc},${camp},Primary Text,${idx + 1},"${item.text.replace(/"/g, '""')}",${item.status.toUpperCase()},${item.text.length} chars,${imageFileName}\n`;
                        }
                    });

                    d.headlines.forEach((item, idx) => {
                        if (item.text) {
                            csvContent += `${acc},${camp},Headline,${idx + 1},"${item.text.replace(/"/g, '""')}",${item.status.toUpperCase()},${item.text.length} chars,${imageFileName}\n`;
                        }
                    });
                    
                    // If image exists but no text, add a row just for the image
                    if (d.selectedImage && d.primaryTexts.every(t => !t.text) && d.headlines.every(h => !h.text)) {
                         csvContent += `${acc},${camp},Image Only,1,N/A,APPROVED,N/A,${imageFileName}\n`;
                    }
                });
            });

            // Add CSV to zip
            zip.file("ad_copy_data.csv", csvContent);

            // Generate and save
            zip.generateAsync({type:"blob"})
            .then(function(content) {
                saveAs(content, "ad_campaign_package.zip");
                showNotification('Package downloaded!');
            });
        };

        // --- Icons ---
        function getIcon(name, classes = "w-5 h-5") {
            // Mapping icons manually since we're using string injection
            const icons = {
                layout: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>`,
                download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
                monitor: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m5 7 14-4"/><path d="m19 3 2 9"/><path d="m21 12-6 9"/><path d="m15 21-14-4"/><path d="m1 17 6-9"/><path d="m7 8 12-5"/></svg>`, 
                globe: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
                trash: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
                type: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg>`,
                image: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>`,
                copy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`,
                check: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
                xcircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`,
                alert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>`
            };
            return icons[name] || '';
        }

        // --- Render ---
        function render() {
            const accConfig = ACCOUNTS[state.account];
            const data = getCurrentData();

            // Status Control HTML Generator
            const renderStatusControls = (type, index, status) => `
                <div class="flex items-center gap-1">
                    <button onclick="updateStatus('${type}', ${index}, 'pending')" class="p-1 rounded-md transition-colors ${status === 'pending' ? 'bg-gray-200 text-gray-600' : 'text-gray-300 hover:text-gray-500'}" title="Mark as Pending">${getIcon('alert', 'w-4 h-4')}</button>
                    <button onclick="updateStatus('${type}', ${index}, 'rejected')" class="p-1 rounded-md transition-colors ${status === 'rejected' ? 'bg-red-100 text-red-600' : 'text-gray-300 hover:text-red-400'}" title="Reject">${getIcon('xcircle', 'w-4 h-4')}</button>
                    <button onclick="updateStatus('${type}', ${index}, 'approved')" class="p-1 rounded-md transition-colors ${status === 'approved' ? 'bg-green-100 text-green-600' : 'text-gray-300 hover:text-green-400'}" title="Approve">${getIcon('check', 'w-4 h-4')}</button>
                </div>
            `;

            const html = `
                <!-- Header -->
                <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
                    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg text-white ${accConfig.color}">
                                ${getIcon('layout', 'w-6 h-6')}
                            </div>
                            <h1 class="text-xl font-bold tracking-tight">Ad Copy Manager</h1>
                        </div>
                        <button onclick="exportPackage()" class="flex items-center gap-2 px-4 py-2 bg-slate-800 text-white rounded-md hover:bg-slate-700 transition-colors text-sm font-medium shadow-sm">
                            ${getIcon('download', 'w-4 h-4')} Export Package (ZIP)
                        </button>
                    </div>
                </header>

                <main class="flex-1 max-w-6xl mx-auto w-full p-4 md:p-6 space-y-6">
                    
                    <!-- Account Selector -->
                    <div class="grid grid-cols-2 gap-4">
                        ${Object.keys(ACCOUNTS).map(acc => `
                            <button onclick="setAccount('${acc}')" class="flex items-center justify-center gap-3 p-4 rounded-xl border-2 transition-all duration-200 ${state.account === acc ? `${ACCOUNTS[acc].themeBorder} bg-white ring-1 ring-offset-2 ${ACCOUNTS[acc].themeRing}` : 'border-transparent bg-white hover:bg-gray-50 text-gray-400'} shadow-sm">
                                <span class="${state.account === acc ? ACCOUNTS[acc].themeText : 'text-gray-400'}">
                                    ${acc === 'NimiTV' ? getIcon('monitor') : getIcon('globe')}
                                </span>
                                <span class="text-lg font-bold ${state.account === acc ? 'text-slate-900' : 'text-gray-400'}">${ACCOUNTS[acc].label}</span>
                            </button>
                        `).join('')}
                    </div>

                    <!-- Campaign Selector -->
                    <div class="bg-white p-2 rounded-lg shadow-sm border border-gray-200 flex flex-wrap gap-2">
                        ${accConfig.campaigns.map(camp => `
                            <button onclick="setCampaign('${camp}')" class="px-4 py-2 rounded-md text-sm font-medium transition-colors ${state.campaign === camp ? `${accConfig.color} text-white shadow-sm` : 'text-gray-600 hover:bg-gray-100'}">
                                ${camp} Campaign
                            </button>
                        `).join('')}
                    </div>

                    <!-- Editor Area -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                            <div>
                                <h2 class="text-lg font-semibold flex items-center gap-2">
                                    <span class="${accConfig.themeText}">${state.account}</span>
                                    <span class="text-gray-300">/</span>
                                    <span>${state.campaign}</span>
                                </h2>
                                <p class="text-xs text-gray-500 mt-1">Drafting ${state.campaign} ad variations</p>
                            </div>
                            <button onclick="clearCampaign()" class="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-colors">
                                ${getIcon('trash')}
                            </button>
                        </div>

                        <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-100">
                            
                            <!-- Left: Primary Text -->
                            <div class="p-6 space-y-6">
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="p-1.5 bg-indigo-100 text-indigo-600 rounded">${getIcon('type', 'w-4 h-4')}</div>
                                    <h3 class="font-semibold text-gray-700">Primary Text</h3>
                                    <span class="ml-auto text-xs font-medium text-gray-400 uppercase tracking-wider">Up to 5 Options</span>
                                </div>
                                <div class="space-y-6">
                                    ${data.primaryTexts.map((item, idx) => `
                                        <div class="group relative">
                                            <div class="flex justify-between items-center mb-1.5">
                                                <label class="text-xs font-medium text-gray-400 flex items-center gap-2">
                                                    Option ${idx + 1}
                                                    ${item.status === 'approved' ? '<span class="text-green-600 font-bold">APPROVED</span>' : ''}
                                                    ${item.status === 'rejected' ? '<span class="text-red-500 font-bold">REJECTED</span>' : ''}
                                                </label>
                                                ${renderStatusControls('primaryTexts', idx, item.status)}
                                            </div>
                                            <div class="relative">
                                                <textarea 
                                                    id="primaryTexts-${idx}"
                                                    oninput="updateText('primaryTexts', ${idx}, this.value)" 
                                                    placeholder="Enter primary ad text..." 
                                                    class="w-full p-3 pr-10 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent min-h-[100px] resize-none transition-shadow ${getStatusClasses(item.status)}">${item.text}</textarea>
                                                <div class="absolute bottom-2 right-2 text-xs font-medium ${item.text.length > 125 ? 'text-orange-500' : 'text-gray-300'}">${item.text.length}</div>
                                                <button onclick="copyToClipboard(document.getElementById('primaryTexts-${idx}').value)" class="absolute top-2 right-2 p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-md opacity-0 group-hover:opacity-100 transition-all">
                                                    ${getIcon('copy', 'w-4 h-4')}
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Right: Headlines & Media -->
                            <div class="flex flex-col divide-y divide-gray-100">
                                <!-- Headlines -->
                                <div class="p-6 space-y-6 bg-gray-50/30">
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="p-1.5 bg-emerald-100 text-emerald-600 rounded">${getIcon('layout', 'w-4 h-4')}</div>
                                        <h3 class="font-semibold text-gray-700">Headlines</h3>
                                        <span class="ml-auto text-xs font-medium text-gray-400 uppercase tracking-wider">Up to 5 Options</span>
                                    </div>
                                    <div class="space-y-4">
                                        ${data.headlines.map((item, idx) => `
                                            <div class="group relative">
                                                <div class="flex justify-between items-center mb-1.5">
                                                    <label class="text-xs font-medium text-gray-400">Headline ${idx + 1}</label>
                                                    ${renderStatusControls('headlines', idx, item.status)}
                                                </div>
                                                <div class="relative">
                                                    <input 
                                                        id="headlines-${idx}"
                                                        type="text" 
                                                        oninput="updateText('headlines', ${idx}, this.value)" 
                                                        value="${item.text.replace(/"/g, '&quot;')}"
                                                        placeholder="Enter catchy headline..." 
                                                        class="w-full p-3 pr-16 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-shadow ${getStatusClasses(item.status)}">
                                                    <div class="absolute top-1/2 -translate-y-1/2 right-10 text-xs font-medium ${item.text.length > 40 ? 'text-orange-500' : 'text-gray-300'}">${item.text.length}</div>
                                                    <button onclick="copyToClipboard(document.getElementById('headlines-${idx}').value)" class="absolute top-1/2 -translate-y-1/2 right-2 p-1.5 text-gray-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-md opacity-0 group-hover:opacity-100 transition-all">
                                                        ${getIcon('copy', 'w-4 h-4')}
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Media -->
                                <div class="p-6 space-y-6">
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="p-1.5 bg-rose-100 text-rose-600 rounded">${getIcon('image', 'w-4 h-4')}</div>
                                        <h3 class="font-semibold text-gray-700">Ad Creative</h3>
                                    </div>
                                    ${!data.selectedImage ? `
                                        <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center hover:border-indigo-400 hover:bg-indigo-50 transition-colors">
                                            <input type="file" id="file-upload" class="hidden" accept="image/png, image/jpeg" onchange="handleImageUpload(this)">
                                            <label for="file-upload" class="cursor-pointer flex flex-col items-center gap-2">
                                                <div class="p-3 bg-white rounded-full shadow-sm text-gray-400">${getIcon('image', 'w-6 h-6')}</div>
                                                <span class="text-sm font-medium text-indigo-600">Upload Image</span>
                                                <span class="text-xs text-gray-400">PNG or JPG</span>
                                            </label>
                                        </div>
                                    ` : `
                                        <div class="relative group rounded-xl overflow-hidden border border-gray-200 bg-gray-50">
                                            <img src="${data.selectedImage.data}" alt="Ad Creative" class="w-full h-48 object-cover">
                                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                <button onclick="removeImage()" class="p-2 bg-white text-red-600 rounded-full hover:bg-red-50 transition-colors shadow-lg" title="Remove image">
                                                    ${getIcon('trash', 'w-5 h-5')}
                                                </button>
                                            </div>
                                            <div class="absolute bottom-0 inset-x-0 bg-white/90 backdrop-blur px-3 py-2 text-xs font-medium text-gray-600 border-t border-gray-200 truncate">
                                                ${data.selectedImage.name}
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            `;

            app.innerHTML = html;
        }

        // Initial Render
        render();

    </script>
</body>
</html>
